# Тестовое задание ЦФТ

## Описание

Веб-сервис, позволяющий пользователям "сотрудникам" осуществлять просмотр текущей зарплаты и даты следующего повышения. Проект реализован в соответствии с принципами REST. Критичные данные доступны только лишь причастному пользователю. Аутентификация осуществляется с помощью токена.

Реализованы следующие функицональные возможности:

- [Регистрация пользователей](#регистрация)
- [Аутентификация](#аутентификация)
- [Просмотр зарплаты и даты следующего повышения](#просмотр-зарплаты-и-даты-следующего-повышения)

---

## Запуск

**!!! Необходим установленный Docker на машине запуска**

Переименуйте файл `.env.dev` в файл `.env` и при необходимости скоррекируйте указанные переменные.
Выполните команду ниже из корневой директории.

```
docker compose up --build -d
```

Это позволит создать сеть приложения, состоящую из контейнера с самим приложением и двух контейнеров с основной базой данных PostgreSQL и базой данных для тестов. Скрипт внутри приложения выполнит необходимые миграции БД и запустит сервер.

При успешном выполнении документация OpenAPI станет доступна по [адресу](http://127.0.0.1:8000/docs). 

При желании ручного тестирования можно запустить скрипт, который заполнит БД фейковыми данными. 

```
docker exec -it backend python -m mock_data_loader
```

В итоге в базе данных появятся 10 записей с данными пользователей и их зарплатами, где `username = "user{i}"`, `password = "password{i}"`


---

## Примеры пользования

Сервис предоставляет API, где с помощью HTTP запросов по следующим ендпоинтам возможно взаимодействие с сервисом. 


### **Регистрация**

Регистрация осуществляется POST запросом по маршруту `/users`. Тело запроса должно содержать `уникальный username` пользователя и `password от 8 до 50 символов` в формате JSON.

Пример запроса

```
curl -L -X POST "localhost:8000/users" \
-H "Content-Type: application/json" \
-d "{
    \"username\": \"username\",
    \"password\": \"password\"
}"
```

Примеры ответов

- `201 Created`

```
{
    "id": "2b044cc5-f32b-4aed-b812-0af310c3f63c",
    "username": "username"
}
```

- `422 Unprocessable Entity`

В случае существующего пользователя с таким же username.

```
{
    "detail": "User with username 'username' already exists"
}
```

В случае ошибки валидации пароля.

```
{
    "detail": [
        {
            "loc": [
                "body",
                "password"
            ],
            "msg": "ensure this value has at least 8 characters",
            "type": "value_error.any_str.min_length",
            "ctx": {
                "limit_value": 8
            }
        }
    ]
}
```

### **Аутентификация**

Аутентификация пользователя осуществляется POST запросом по маршруту `/auth/jwt`. Тело запроса должно содержать `form-data` со следующими данными: `username` и `password`.

Пример запроса

```
curl -L -X POST "localhost:8000/auth/jwt" \
-F "username=\"username\"" \
-F "password=\"password\""
```

Примеры ответов

- `200 OK` в случае успешного запроса

```
{
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2ODY5OTA0OTEsInN1YiI6InVzZXJuYW1lIn0.Q1MLmP_xkgkKPlWW03OkMXEJHTc1xevmzx7ULVlFmQE",
    "token_type": "bearer"
}
```

- `401 Unauthorized` в случае не ошибки в данных, или не существующего пользователя.

```
{
    "detail": "Incorrect username or password"
}
```
### **Просмотр зарплаты и даты следующего повышения**


Просмотр текущей зарплаты и даты следующего повышения осуществляется GET запросом по маршруту `users/{username}/salary`. Заголовок запроса должен содержать следующее: `Authorization: Bearer {token}`

Пример запроса

```
curl -L -X GET "localhost:8000/users/user1/salary" \
-H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2ODY5OTEwNTQsInN1YiI6InVzZXIxIn0.gBgweIFYGr99rEDOCe7XtZGqL7Yo-aKCNgVF_a9rZeY"
```

Примеры ответов

- `200 OK` в случае успешного запроса.

```
{
    "salary": 1000.0,
    "increase_date": "2023-06-18"
}
```

- `403 Forbidden` в случае запроса пользователя, не являющегося причастным к данным.

```
{
    "detail": "You don't have permission"
}
```

- `404 Not Found` в случсе запроса к несуществующему пользователю

```
{
    "detail": "User 'use' doesnt't exist"
}
```
---

## Тестирование

В течение работы над приложением были протестированы следующие поведенченские модели приложения:

**Регистрация**
- Пользователь с уникальным username успешно может зарегистрироваться.
- Пользователь с повторяющимся username получит ошибку 422

**Аутентификация** 
- Зарегистрированный пользователь успешно может получить токен аутентификации
- Несуществующий пользователь получит ошибку 401

**Просмотр зарплаты и даты повышения**
- Аутентифицированный пользователь успешно получит собственные данные о зарплате
- Аутентифицированный пользователь получит ошибку 403 при попытке получить данные о зарплате другого пользователя.
- Ошибка 404 в случае, если указанного пользователя не существует.


Подтверждение доступно при выполнении следующей команды:

```
docker exec -it backend pytest -v
```
